

/*Question 1:
Create a query that lists each film category, and the number of times it has been rented out.*/

SELECT c.name as category_name, count(r.rental_id) AS rental_count
FROM film f JOIN film_category fc
ON f.film_id=fc.film_id
JOIN category c
ON c.category_id=fc.category_id
JOIN inventory i
ON f.film_id=i.film_id
JOIN rental r
ON i.inventory_id=r.inventory_id
GROUP BY 1 ORDER BY 2 DESC;


/*Question 2:
FIND out revenue generated by top 10 actors, whose movies were rented most? */

WITH top_actors as (SELECT a.actor_id,a.first_name||' '||a.last_name AS full_name, COUNT(r.rental_id) AS total_rented
FROM actor a JOIN film_actor fa
ON a.actor_id=fa.actor_id
JOIN film f
ON f.film_id=fa.film_id
JOIN inventory i
ON i.film_id=f.film_id
JOIN rental r
ON r.inventory_id=i.inventory_id
GROUP BY 1,2 ORDER BY 3 DESC LIMIT 10)

SELECT a.actor_id,a.full_name,sum(p.amount) AS total_amount
FROM top_actors a JOIN film_actor fa
ON fa.actor_id=a.actor_id
JOIN inventory i
ON fa.film_id=i.film_id
JOIN rental r
ON i.inventory_id=r.inventory_id
JOIN payment p
ON p.rental_id=r.rental_id
GROUP BY 1,2 ORDER BY 3 DESC;



/*Question 3:
We want to find out how the two stores compare in their count of rental orders during every month for all the years we have data for.
Write a query that returns the store ID for the store, the year and month and the number of rental orders each store has fulfilled for that month.*/

SELECT date_part('month',r.rental_date) AS rental_month, date_part('year',r.rental_date) AS rental_year,
       s.store_id, COUNT(r.rental_id) AS COUNT_RENTALS
FROM staff s JOIN rental r
ON s.staff_id=r.staff_id
GROUP BY 1,2,3 ORDER BY 2,1;


/*Question 4:
We would like to know who were our top 10 paying customers, how many payments they made on a monthly basis during 2007, and what was the amount of the monthly payments.*/

WITH top_customers as (SELECT distinct c.customer_id, c.first_name||' '||c.last_name AS Full_name,
SUM(p.amount) OVER (PARTITION BY c.customer_id) AS total_amount
FROM customer c
JOIN payment p
ON c.customer_id=p.customer_id
ORDER BY 3 DESC LIMIT 10)

SELECT date_trunc('month',p.payment_date) AS pay_month, tc.full_name, COUNT(*) AS Count_per_month, sum(p.amount) AS pay_amount
FROM top_customers tc JOIN payment p
ON p.customer_id=tc.customer_id
GROUP BY 1,2 ORDER BY 2,1;
